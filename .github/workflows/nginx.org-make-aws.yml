name: nginx.org build

on:
  workflow_call:
    secrets:
      AZURE_VAULT_CLIENT_ID:
        required: true
      AZURE_VAULT_SUBSCRIPTION_ID:
        required: true
      AZURE_VAULT_TENANT_ID:
        required: true
      DOCS_VAULTNAME:
        required: true
    inputs:
      deployment_env:
        required: false
        type: string
        default: staging
      url_prod:
        required: false
        type: string
        default: nginx.org
      url_staging:
        required: false
        type: string
        default: staging.nginx.org
      s3_bucket:
        required: false
        type: string
        default: nginx-org-staging
      aws_region:
        required: false
        type: string
        default: eu-central-1
  
permissions:
  contents: read
  id-token: write

defaults:
  run:
    shell: 'bash -Eeo pipefail -x {0}'

jobs:
  build-staging:
    name: build-staging
    runs-on: ubuntu-latest
    if: ${{ inputs.deployment_env == 'staging' }}

    steps:        
      - name: Azure login
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2.3.0
        with:
          client-id: ${{ secrets.AZURE_VAULT_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_VAULT_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_VAULT_SUBSCRIPTION_ID }}

      - name: Retrieve secrets from Keyvault
        id: keyvault
        uses: azure/cli@089eac9d8cc39f5d003e94f8b65efc51076c9cbd # v2.1.0
        with:
          inlineScript: |
            secrets_get=(NginxOrgAwsAccountID NginxOrgAwsRoleName NginxOrgAllowedUsers)
            for secret_get in ${secrets_get[@]}
            do
              value=$(az keyvault secret show --name $secret_get --vault-name '${{ secrets.DOCS_VAULTNAME }}' --query value --output tsv)
              printf '::add-mask::%s\n' "$value"
              {
                echo "$secret_get<<EOF"
                printf '%s\n' "$value"
                echo "EOF"
              } >> "$GITHUB_OUTPUT"
            done

      - name: Check if we're in the allowed environment
        env:
          ALLOWED_USERS: ${{ steps.keyvault.outputs.NginxOrgAllowedUsers }}
          DEPLOYMENT_ENV: ${{ inputs.deployment_env }}
        run: |
          org_found=0
          event_found=0
          ref_found=0
          user_found=0
          ALLOWED_ORGS="nginx nginxinc"
          ALLOWED_EVENTS="push workflow_dispatch"
          ALLOWED_REFS="refs/heads/main"
          USER_LIST="$(printf '%s' "$ALLOWED_USERS" | tr ',\n' '  ')"
          for org in $ALLOWED_ORGS; do
            if [ "$org" == "$GITHUB_REPOSITORY_OWNER" ]; then org_found=1; fi
          done
          for event in $ALLOWED_EVENTS; do
            if [ "$event" == "$GITHUB_EVENT_NAME" ]; then event_found=1; fi
          done
          for ref in $ALLOWED_REFS; do
            if [ "$DEPLOYMENT_ENV" = "prod" ]; then
              if [ "$ref" == "$GITHUB_REF" ]; then ref_found=1; fi
            else
              ref_found=1
            fi
          done
          for user in $USER_LIST; do
            if [ "$DEPLOYMENT_ENV" = "prod" ]; then
              if [ "$user" == "$GITHUB_ACTOR" ]; then user_found=1; fi
            else
              user_found=1
            fi
          done
          if [ $org_found$event_found$ref_found$user_found -ne 1111 ]; then
            echo "Repository owner, event, ref or actor are not explicitely allowed to use this workflow: $GITHUB_REPOSITORY_OWNER, $GITHUB_EVENT_NAME, $GITHUB_REF, $GITHUB_ACTOR"
            exit 1
          fi
          exit 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libxslt1-dev xsltproc libxml2-utils netpbm python-is-python3

      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC (assume role)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ steps.keyvault.outputs.NginxOrgAwsAccountID }}:role/${{ steps.keyvault.outputs.NginxOrgAwsRoleName }}
          aws-region: ${{ inputs.aws_region }}

      - name: Build
        if: ${{ inputs.deployment_env == 'staging' }}
        run: |
          set -e
          make all
          make gzip
          make images
          make genapi
          make all
          make dir.map
          make copy NGINX_ORG=www
          cp dir.map www/
          
          # Verify build output
          if [ ! -d www ]; then
            echo "Error: Build did not create www/ directory"
            exit 1
          fi

      - name: Compute safe repo name
        id: vars
        run: |
          echo "safe_repo=${GITHUB_REPOSITORY//\//-}" >> "$GITHUB_OUTPUT"
          
      - name: Sync www/ to S3
        run: |
          aws s3 sync \
          www/ \
          s3://${{ inputs.s3_bucket }}/${{ steps.vars.outputs.safe_repo }}/staging/${GITHUB_SHA}/ \
          --delete --exact-timestamps

      - name: Upload staging markers (.deployed.txt)
        run: |
          TIMESTAMP="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          cat > .deployed.txt <<-EOF
            sha=${GITHUB_SHA}
            env=staging
            ts=${TIMESTAMP}
            actor=${GITHUB_ACTOR}
            repo=${GITHUB_REPOSITORY}
          EOF
          aws s3 cp .deployed.txt \
            s3://${{ inputs.s3_bucket }}/${{ steps.vars.outputs.safe_repo }}/staging/${GITHUB_SHA}/.deployed.txt
          aws s3 cp .deployed.txt \
            s3://${{ inputs.s3_bucket }}/${{ steps.vars.outputs.safe_repo }}/staging/.deployed.txt

      - name: Deployment summary
        env:
          DEPLOYMENT_ENV: ${{ inputs.deployment_env }}
        run: |
          {
            echo "### Deployment Summary"
            echo ""
            echo "| Key             | Value |"
            echo "|------------------|-------|"
            echo "| deployment_env  | $DEPLOYMENT_ENV |"
            echo "| repository      | $GITHUB_REPOSITORY |"
            echo "| actor           | $GITHUB_ACTOR |"
            echo "| commit          | $GITHUB_SHA |"
            echo "| Public URL      | https://${{ inputs.url_staging }}/${GITHUB_SHA} |"
          } >> $GITHUB_STEP_SUMMARY
          
  build-prod:
    name: build-prod
    runs-on: ubuntu-latest
    if: ${{ inputs.deployment_env == 'prod' }}


    steps:
      - name: Azure login
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2.3.0
        with:
          client-id: ${{ secrets.AZURE_VAULT_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_VAULT_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_VAULT_SUBSCRIPTION_ID }}

      - name: Retrieve secrets from Keyvault
        id: keyvault
        uses: azure/cli@089eac9d8cc39f5d003e94f8b65efc51076c9cbd # v2.1.0
        with:
          inlineScript: |
            secrets_get=(NginxOrgAwsAccountID NginxOrgAwsRoleName NginxOrgAllowedUsers)
            for secret_get in ${secrets_get[@]}
            do
              value=$(az keyvault secret show --name $secret_get --vault-name '${{ secrets.DOCS_VAULTNAME }}' --query value --output tsv)
              printf '::add-mask::%s\n' "$value"
              {
                echo "$secret_get<<EOF"
                printf '%s\n' "$value"
                echo "EOF"
              } >> "$GITHUB_OUTPUT"
            done

      - name: Check if we're in the allowed environment
        env:
          ALLOWED_USERS: ${{ steps.keyvault.outputs.NginxOrgAllowedUsers }}
          DEPLOYMENT_ENV: ${{ inputs.deployment_env }}
        run: |
          org_found=0
          event_found=0
          ref_found=0
          user_found=0
          ALLOWED_ORGS="nginx nginxinc"
          ALLOWED_EVENTS="push workflow_dispatch"
          ALLOWED_REFS="refs/heads/main"
          USER_LIST="$(printf '%s' "$ALLOWED_USERS" | tr ',\n' '  ')"
          for org in $ALLOWED_ORGS; do
            if [ "$org" == "$GITHUB_REPOSITORY_OWNER" ]; then org_found=1; fi
          done
          for event in $ALLOWED_EVENTS; do
            if [ "$event" == "$GITHUB_EVENT_NAME" ]; then event_found=1; fi
          done
          for ref in $ALLOWED_REFS; do
            if [ "$DEPLOYMENT_ENV" = "prod" ]; then
              if [ "$ref" == "$GITHUB_REF" ]; then ref_found=1; fi
            else
              ref_found=1
            fi
          done
          for user in $USER_LIST; do
            if [ "$DEPLOYMENT_ENV" = "prod" ]; then
              if [ "$user" == "$GITHUB_ACTOR" ]; then user_found=1; fi
            else
              user_found=1
            fi
          done
          if [ $org_found$event_found$ref_found$user_found -ne 1111 ]; then
            echo "Repository owner, event, ref or actor are not explicitely allowed to use this workflow: $GITHUB_REPOSITORY_OWNER, $GITHUB_EVENT_NAME, $GITHUB_REF, $GITHUB_ACTOR"
            exit 1
          fi
          exit 0

      - name: Configure AWS credentials via OIDC (assume role)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ steps.keyvault.outputs.NginxOrgAwsAccountID }}:role/${{ steps.keyvault.outputs.NginxOrgAwsRoleName }}
          aws-region: ${{ inputs.aws_region }}
      
      - name: Compute safe repo name
        id: vars
        run: |
          echo "safe_repo=${GITHUB_REPOSITORY//\//-}" >> "$GITHUB_OUTPUT"
          
      - name: Wait for staging marker for this SHA
        run: |
          set -e
          S3="s3://${{ inputs.s3_bucket }}/${{ steps.vars.outputs.safe_repo }}/staging/${GITHUB_SHA}/.deployed.txt"
          for i in $(seq 1 10); do
            if aws s3 cp "$S3" .staging.marker --only-show-errors; then
              grep -q 'sha=' .staging.marker && grep -q 'env=staging' .staging.marker && exit 0 || true
            fi
            sleep 10
          done
          echo "staging marker not ready for ${GITHUB_SHA}" >&2
          exit 1

      - name: Sync www/ to S3
        run: |
          aws s3 sync \
          s3://${{ inputs.s3_bucket }}/${{ steps.vars.outputs.safe_repo }}/staging/${GITHUB_SHA}/ \
          s3://${{ inputs.s3_bucket }}/${{ steps.vars.outputs.safe_repo }}/prod/ \
          --delete --exact-timestamps

      - name: Upload prod marker (.deployed.txt)
        run: |
          TIMESTAMP="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          cat > .deployed.txt <<-EOF
            sha=${GITHUB_SHA}
            env=prod
            ts=${TIMESTAMP}
            actor=${GITHUB_ACTOR}
            repo=${GITHUB_REPOSITORY}
          EOF
          aws s3 cp .deployed.txt \
            s3://${{ inputs.s3_bucket }}/${{ steps.vars.outputs.safe_repo }}/prod/.deployed.txt

      - name: Deployment summary
        env:
          DEPLOYMENT_ENV: ${{ inputs.deployment_env }}
        run: |
          {
            echo "### Deployment Summary"
            echo ""
            echo "| Key             | Value |"
            echo "|------------------|-------|"
            echo "| deployment_env  | $DEPLOYMENT_ENV |"
            echo "| repository      | $GITHUB_REPOSITORY |"
            echo "| actor           | $GITHUB_ACTOR |"
            echo "| commit          | $GITHUB_SHA |"
            echo "| Public URL      | https://${{ inputs.url_prod }} |"
          } >> $GITHUB_STEP_SUMMARY
