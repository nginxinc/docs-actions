name: Docs Build Push
on:
  workflow_call:
    secrets:
      AZURE_CREDENTIALS:
        required: true
      AZURE_KEY_VAULT:
        required: true
    inputs:
      environment:
        description: "Deployment environment. Must be one of: preview, dev, staging, prod, staging_techdocs, techdocs"
        required: false
        default: preview
        type: string
      production_url_path:
        description: "This will be appended to the baseURL for production builds. For example, main docs will be `/` where agent would be `/nginx-agent`"
        required: true
        type: string
      preview_url_path:
        description: "Appended to the baseURL for PR preview builds"
        required: true
        type: string
      docs_source_path:
        description: "Directory of built docs files. Hugo default would be `./public/`"
        required: true
        type: string
      docs_build_path:
        description: "Directory where hugo build command should be run from"
        required: false
        type: string
        default: ./
      force_hugo_theme_version:
        type: string
        description: "Overrides default of latest hugo theme. Useful for testing pre-release versions. Must start with 'v' before version."
        default: ""
      auto_deploy_branch:
        type: string
        description: "A branch specified here will autodeploy to the environment specified in auto_deploy_env. An on.push event for this branch must be specified in caller."
      auto_deploy_env:
        type: string
        description: "Env to which auto_deploy_branch will be deployed to. Preview is not supported."
      node_dep:
        type: boolean
        description: "Defines should we run npm ci or not"
        default: false
    outputs:
      DEPLOY_URL:
        description: String representing the URL of the deployed build (preview or environment)
        value: ${{ jobs.build.outputs.DEPLOY_URL }}
      PREVIEW_URL:
        description: String representing the URL to preview the build (only meaningful for preview deployments)
        value: ${{ jobs.build.outputs.PREVIEW_URL }}

env:
  GO_VERSION: "1.21" # Go version used for `hugo mod get`
  HUGO_VERSION: "0.147.8" # Hugo version used for building docs
  THEME_MODULE: "github.com/nginxinc/nginx-hugo-theme/v2"
  PR_NUMBER: ${{ github.event.pull_request.number }}

  # domains
  DOMAIN_PREVIEW: "frontdoor-test-docs.nginx.com"
  DOMAIN_DEV: "docs-dev.nginx.com"
  DOMAIN_STAGING: "docs-staging.nginx.com"
  DOMAIN_PROD: "docs.nginx.com"
  DOMAIN_STAGING_TECHDOCS: "staging.techdocs.f5.com"
  DOMAIN_TECHDOCS: "techdocs.f5.com"

jobs:
  checks:
    name: Checks and variables
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    outputs:
      forked_workflow: ${{ steps.vars.outputs.forked_workflow }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Set Variables
        id: vars
        run: |
          echo "forked_workflow=${{ (github.event.pull_request && github.event.pull_request.head.repo.full_name != github.event.pull_request.base.repo.full_name) || !(startsWith(github.repository, 'nginx/') || startsWith(github.repository, 'nginxinc/')) }}" >> $GITHUB_OUTPUT
      - name: Output variables
        run: |
          echo forked_workflow: ${{ steps.vars.outputs.forked_workflow }}

  build:
    needs: [checks]
    if: ${{ needs.checks.outputs.forked_workflow == 'false' }}
    runs-on: ubuntu-24.04
    outputs:
      DEPLOY_URL: ${{ steps.summary.outputs.DEPLOY_URL }}
      PREVIEW_URL: ${{ steps.summary.outputs.PREVIEW_URL }}
    env:
      # Remapping of inputs to envs
      PRODUCTION_URL_PATH: ${{ inputs.production_url_path }}
      PREVIEW_URL_PATH: ${{ inputs.preview_url_path }}
      DOCS_SOURCE_PATH: ${{ inputs.docs_source_path }}
      DEPLOYMENT_ENV: ${{ inputs.environment }}
      THEME_VERSION: ${{ inputs.force_hugo_theme_version }}
      AUTO_DEPLOY_BRANCH: ${{ inputs.auto_deploy_branch }}
      AUTO_DEPLOY_ENV: ${{ inputs.auto_deploy_env }}
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
    steps:
      - name: Check and setup auto-deploy
        # Auto deploy should only trigger when the auto_deploy_branch matches the current ref.
        # We also check if `environment` has already been set, otherwise this flow could cause
        # manual triggers to deploy to `auto_deploy_env` instead of the one specified in the trigger.
        if: (inputs.auto_deploy_branch == github.ref_name) && inputs.environment == ''
        run: |
          echo "Auto deploy branch ($AUTO_DEPLOY_BRANCH) matches current branch. Attempting autodeploy to $AUTO_DEPLOY_ENV."
          echo "DEPLOYMENT_ENV=${AUTO_DEPLOY_ENV}" >> $GITHUB_ENV

      - name: Validate environment inputs
        run: |
          if [[ ! "${DEPLOYMENT_ENV}" =~ ^(dev|staging|prod|preview|staging_techdocs|techdocs)$ ]]; then
            echo "::error::Invalid environment input: ${DEPLOYMENT_ENV}. Must be one of dev, staging, prod, preview, staging_techdocs, techdocs"
            exit 1
          fi

          if [[ "${DEPLOYMENT_ENV}" == "preview" && -z "${PR_NUMBER}" ]]; then
            echo "PR_NUMBER=${GITHUB_SHA::7}" >> "$GITHUB_ENV"
            echo "::notice::PR_NUMBER set to short commit hash: ${GITHUB_SHA::7}"
          fi

      - name: Set deployment variables
        id: deployment
        run: |
          # Compute preview state once (used for build/upload/comment)
          if [[ "${DEPLOYMENT_ENV}" == "preview" ]] || [[ "${{ github.event.action }}" == "opened" ]] || [[ "${{ github.event.action }}" == "synchronize" ]]; then
            echo "IS_PREVIEW=true" >> "$GITHUB_ENV"
          else
            echo "IS_PREVIEW=false" >> "$GITHUB_ENV"
          fi

          # Map environment -> domain + storage prefix
          case "${DEPLOYMENT_ENV}" in
            dev)
              DOMAIN="${DOMAIN_DEV}"
              STORAGE_PREFIX="dev"
              ;;
            staging)
              DOMAIN="${DOMAIN_STAGING}"
              STORAGE_PREFIX="staging"
              ;;
            prod)
              DOMAIN="${DOMAIN_PROD}"
              STORAGE_PREFIX="prod"
              ;;
            staging_techdocs)
              DOMAIN="${DOMAIN_STAGING_TECHDOCS}"
              STORAGE_PREFIX="staging_techdocs"
              ;;
            techdocs)
              DOMAIN="${DOMAIN_TECHDOCS}"
              STORAGE_PREFIX="techdocs"
              ;;
            preview)
              DOMAIN="${DOMAIN_PREVIEW}"
              STORAGE_PREFIX="dev"
              ;;
            *)
              echo "::error::Unhandled DEPLOYMENT_ENV '${DEPLOYMENT_ENV}'"
              exit 1
              ;;
          esac

          echo "DEPLOYMENT_DOMAIN=${DOMAIN}" >> "$GITHUB_ENV"
          echo "STORAGE_PREFIX=${STORAGE_PREFIX}" >> "$GITHUB_ENV"

      - name: Azure login
        uses: azure/login@a65d910e8af852a8061c627c456678983e180302 # v2.2.0
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Retrieve secrets from Keyvault
        id: keyvault
        uses: azure/cli@089eac9d8cc39f5d003e94f8b65efc51076c9cbd # v2.1.0
        with:
          inlineScript: |
            secrets_get=(resourceGroupName cdnProfileName cdnName accountName)
            for secret_get in "${secrets_get[@]}"
            do
              value=$(az keyvault secret show --name "$secret_get" --vault-name "${{ secrets.AZURE_KEY_VAULT }}" --query value --output tsv)
              echo "::add-mask::$value"
              echo "$secret_get=$value" >> "$GITHUB_OUTPUT"
            done

      - name: Checkout docs content
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0 # Required for hugo Lastmod

      - name: Get latest hugo theme
        if: inputs.force_hugo_theme_version == ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          THEME_VERSION="$(gh api repos/nginxinc/nginx-hugo-theme/releases/latest -q .tag_name)"
          echo "THEME_VERSION=${THEME_VERSION}" >> "$GITHUB_ENV"

      - name: Setup Go
        uses: actions/setup-go@0a12ed9d6a96ab950c8f026ed9f722fe0da7ef32 # v5.0.2
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@75d2e84710de30f6ff7268e08f310b60ef14033f # v3.0.0
        with:
          hugo-version: ${{ env.HUGO_VERSION }}
          extended: true

      - name: Add hugo build info
        run: |
          timestamp=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          cat <<EOF > buildInfo.json
          {
              "nginxHugoThemeVersion": "$THEME_MODULE@$THEME_VERSION",
              "buildDate": "$timestamp"
          }
          EOF
          mkdir -p "${{ inputs.docs_build_path }}/static/"
          cp buildInfo.json "${{ inputs.docs_build_path }}/static/"

      - name: Setup node deps
        if: inputs.node_dep == true
        working-directory: ${{ inputs.docs_build_path }}
        run: npm ci

      - name: Build Hugo (preview)
        if: env.IS_PREVIEW == 'true'
        working-directory: ${{ inputs.docs_build_path }}
        run: |
          hugo mod get -v "$THEME_MODULE@$THEME_VERSION"
          hugo --gc -e production --baseURL="https://${DEPLOYMENT_DOMAIN}${PREVIEW_URL_PATH}/${PR_NUMBER}"

      - name: Build Hugo (environment)
        if: env.IS_PREVIEW != 'true'
        working-directory: ${{ inputs.docs_build_path }}
        run: |
          hugo mod get -v "$THEME_MODULE@$THEME_VERSION"
          hugo --gc -e production --baseURL="https://${DEPLOYMENT_DOMAIN}${PRODUCTION_URL_PATH}"

      ### Azure upload
      - name: Azure upload (preview)
        uses: azure/cli@089eac9d8cc39f5d003e94f8b65efc51076c9cbd # v2.1.0
        if: env.IS_PREVIEW == 'true'
        with:
          inlineScript: |
            cd "${{ inputs.docs_build_path }}"

            az storage blob upload-batch \
              -s "$DOCS_SOURCE_PATH" \
              -d '$web' \
              --destination-path "dev/${{ github.repository }}/previews/${PR_NUMBER}" \
              --account-name "${{ steps.keyvault.outputs.accountName }}" \
              --overwrite \
              --content-cache-control "max-age=3600" \
              --auth-mode login

            az afd endpoint purge \
              --resource-group "${{ steps.keyvault.outputs.resourceGroupName }}" \
              --profile-name "${{ steps.keyvault.outputs.cdnProfileName }}" \
              --endpoint-name "${{ steps.keyvault.outputs.cdnName }}" \
              --domains "$DOMAIN_PREVIEW" \
              --content-paths "${PREVIEW_URL_PATH}/${PR_NUMBER}/*" \
              --no-wait

      - name: Azure upload (environment)
        uses: azure/cli@089eac9d8cc39f5d003e94f8b65efc51076c9cbd # v2.1.0
        if: env.IS_PREVIEW != 'true'
        with:
          inlineScript: |
            cd "${{ inputs.docs_build_path }}"

            az storage blob upload-batch \
              -s "$DOCS_SOURCE_PATH" \
              -d '$web' \
              --destination-path "${STORAGE_PREFIX}/${{ github.repository }}/latest/" \
              --account-name "${{ steps.keyvault.outputs.accountName }}" \
              --overwrite \
              --content-cache-control "max-age=3600" \
              --auth-mode login

            az afd endpoint purge \
              --resource-group "${{ steps.keyvault.outputs.resourceGroupName }}" \
              --profile-name "${{ steps.keyvault.outputs.cdnProfileName }}" \
              --endpoint-name "${{ steps.keyvault.outputs.cdnName }}" \
              --domains "$DEPLOYMENT_DOMAIN" \
              --content-paths "${PRODUCTION_URL_PATH}/*" \
              --no-wait

      - name: Azure logout
        if: always()
        run: |
          az logout

      ### PR preview comment
      - name: PR preview comment
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        if: env.DEPLOYMENT_ENV == 'preview' && (github.event.action == 'synchronize' || github.event.action == 'opened')
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            const existingComment = comments.find(
              c => c.user.login === 'github-actions[bot]' && c.body.includes('Deploy Preview')
            );
            if (existingComment) return;

            const previewHostname = process.env.DOMAIN_PREVIEW;
            const previewUrlPath = process.env.PREVIEW_URL_PATH;
            const prNumber = context.payload.pull_request.number;
            const previewUrl = `https://${previewHostname}${previewUrlPath}/${prNumber}/`;

            const body = `### <span aria-hidden="true">âœ…</span> Deploy Preview will be available once build job completes!
            |  Name | Link |
            |:-:|------------------------|
            |<span aria-hidden="true">ðŸ˜Ž</span> Deploy Preview | [${previewUrl}](${previewUrl}) |
            ---`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body,
            });

      - name: Summary
        # TODO(dani): Extract this into a reusable Markdown template for comments and summaries?
        id: summary
        run: |
          echo "### Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Task | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| Deployment environment | \`${DEPLOYMENT_ENV}\`|" >> $GITHUB_STEP_SUMMARY
          if [[ "${DEPLOYMENT_ENV}" == "preview" ]]; then
            echo "| Preview URL | [https://${DOMAIN_PREVIEW}${PREVIEW_URL_PATH}/${PR_NUMBER}/](https://${DOMAIN_PREVIEW}${PREVIEW_URL_PATH}/${PR_NUMBER}/) |" >> $GITHUB_STEP_SUMMARY
            echo "PREVIEW_URL=https://${DOMAIN_PREVIEW}${PREVIEW_URL_PATH}/${PR_NUMBER}/" >> $GITHUB_OUTPUT
          else
            echo "| Production URL | [https://${DEPLOYMENT_DOMAIN}${PRODUCTION_URL_PATH}](https://${DEPLOYMENT_DOMAIN}${PRODUCTION_URL_PATH}) |" >> $GITHUB_STEP_SUMMARY
            echo "PREVIEW_URL=https://${DEPLOYMENT_DOMAIN}${PRODUCTION_URL_PATH}" >> $GITHUB_OUTPUT
          fi

        # TODO(dani): Add more details to the summary
